@page "/"
@using System.Linq
@using WebNovels.Models
@using WebNovels.Services.NovelServices
@using WebNovels.Services.ReviewServices
@using WebNovels.Components.Pages.Shared
@inject IReviewService ReviewService
@inject INovelService NovelService
@inject NavigationManager Nav

<PageTitle>Home — Most Read</PageTitle>

@if (isLoading)
{
    <div class="container py-5">
        <div class="placeholder-glow">
            <h1 class="display-6 placeholder col-4"></h1>
            <p class="placeholder col-6"></p>
        </div>
        <div class="row g-3 mt-2">
            @for (int i = 0; i < 9; i++)
            {
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card novel-sm-card">
                        <div class="row g-0 h-100">
                            <div class="col-4">
                                <div class="bg-body-secondary h-100 w-100"></div>
                            </div>
                            <div class="col-8">
                                <div class="card-body">
                                    <h3 class="h6 card-title mb-1 placeholder-glow"><span class="placeholder col-8"></span></h3>
                                    <div class="small text-body-secondary placeholder-glow"><span class="placeholder col-5"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}
else
{
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h4 mb-0"><i class="bi bi-bar-chart-line me-2"></i>Most read novels</h1>
            @* <a class="btn btn-sm btn-outline-primary" href="/novels?sort=reads">View all</a> *@
        </div>

        @if (mostRead?.Count == 0)
        {
            <div class="alert alert-secondary">No reads yet. Start exploring from the <a href="/novels">library</a>.</div>
        }
        else
        {
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                @for (var i = 0; i < mostRead!.Count; i++)
                {
                    var n = mostRead[i];
                    <div class="col">
                        <div class="card novel-sm-card border-0 shadow-sm position-relative">
                            <div class="row g-0 h-100">
                                <div class="col-4">
                                    <img src="@(!string.IsNullOrEmpty(n.CoverImagePath) ? n.CoverImagePath : "/images/default-cover.png")"
                                         class="img-fluid rounded-start"
                                         style="height: 100%; width: 100%; object-fit: cover;"
                                         alt="Cover of @n.Title"
                                         loading="lazy" decoding="async" />
                                </div>

                                <div class="col-8 d-flex flex-column">
                                    <div class="card-body py-2 pe-3 overflow-hidden">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <h3 class="h6 card-title mb-1 text-truncate" title="@n.Title">@n.Title</h3>
                                            <span class="badge text-bg-primary ms-2">#@(i + 1)</span>

                                        </div>

                                        <div class="small text-body-secondary text-truncate" title="@n.Author?.UserName">
                                            @((n.Author?.UserName) ?? "Unknown")
                                        </div>

                                        <div class="mt-2 small text-body-secondary d-flex align-items-center gap-2">
                                            <i class="bi bi-eye"></i><span>@FormatCount(n.ReadCount)</span>
                                            @if (n.Genres?.Any() == true)
                                            {
                                                <span class="vr"></span>
                                                <span class="text-truncate">@string.Join(", ", n.Genres.Select(g => g.Name).Take(2))</span>
                                            }
                                        </div>

                                        <div class="mt-1">
                                            @{
                                                if (ratingLookup.TryGetValue(n.Id, out var s) && s.Count > 0)
                                                {
                                                    <StarRating Rating="s.Average" Count="s.Count" />
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">No ratings</span>
                                                }
                                            }
                                        </div>

                                    </div>

                                    <div class="card-footer bg-transparent border-0 py-2 mt-auto"></div>
                                </div>
                            </div>

                            <a class="stretched-link" href="@($"/novels/details/{n.Id}")" aria-label="Open @n.Title"></a>
                        </div>
                    </div>
                }
            </div>
        }

        @if (trending is { Count: > 0 })
        {
            <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
                <h1 class="h4 mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Trending — last 30 days</h1>
            </div>

            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                @for (var i = 0; i < trending.Count; i++)
                {
                    var item = trending[i];
                    var novel = item.Novel;

                    <div class="col">
                        <div class="card novel-sm-card border-0 shadow-sm position-relative">
                            <div class="row g-0 h-100">
                                <div class="col-4 h-100">
                                    <img src="@(!string.IsNullOrEmpty(novel.CoverImagePath) ? novel.CoverImagePath : "/images/default-cover.png")"
                                         class="img-cover rounded-start"
                                         alt="Cover of @novel.Title"
                                         loading="lazy" decoding="async" />
                                </div>

                                <div class="col-8 h-100 d-flex flex-column">
                                    <div class="card-body py-2 pe-3 overflow-hidden">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <h3 class="h6 card-title mb-1 clamp-2" title="@novel.Title">@novel.Title</h3>
                                            <span class="badge text-bg-primary ms-2">#@(i + 1)</span>
                                        </div>

                                        <div class="small text-body-secondary text-truncate" title="@novel.Author?.UserName">
                                            @((novel.Author?.UserName) ?? "Unknown")
                                        </div>

                                        <div class="mt-2 small text-body-secondary d-flex align-items-center gap-2">
                                            <i class="bi bi-eye"></i>
                                            <span>@FormatCount(item.ReadCount) last 30d</span>
                                            @if (novel.Genres?.Any() == true)
                                            {
                                                <span class="vr"></span>
                                                <span class="text-truncate">@string.Join(", ", novel.Genres.Select(g => g.Name).Take(2))</span>
                                            }
                                        </div>

                                        <div class="mt-1">
                                            @{
                                                if (ratingLookup.TryGetValue(novel.Id, out var s) && s.Count > 0)
                                                {
                                                    <StarRating Rating="s.Average" Count="s.Count" />
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">No ratings</span>
                                                }
                                            }
                                        </div>

                                    </div>
                                    <div class="card-footer bg-transparent border-0 py-2 mt-auto"></div>
                                </div>
                            </div>

                            <a class="stretched-link" href="@($"/novels/details/{novel.Id}")" aria-label="Open @novel.Title"></a>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}




@code {
    private bool isLoading = true;
    private List<Novel>? mostRead;
    private List<(Novel Novel, int ReadCount)>? trending;
    private Dictionary<int, (double Average, int Count)> ratingLookup = new();


    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        mostRead = await NovelService.GetMostReadNovelsAsync(12);
        trending = await NovelService.GetTrendingNovelsAsync(30, 12);

        var ids =
        (mostRead ?? new()).Select(n => n.Id)
        .Concat((trending ?? new()).Select(t => t.Novel.Id))
        .Distinct();

        ratingLookup = await ReviewService.GetSummariesAsync(ids);

        isLoading = false;
    }

    private static string FormatCount(int n)
    {
        if (n >= 1_000_000) return $"{n / 1_000_000d:0.#}M";
        if (n >= 1_000) return $"{n / 1_000d:0.#}k";
        return n.ToString("N0");
    }
}
